\hypertarget{svea__arduino__src_8ino}{}\section{/home/nvidia/starter\+\_\+ws/src/svea\+\_\+starter/src/svea\+\_\+arduino/svea\+\_\+arduino\+\_\+src/svea\+\_\+arduino\+\_\+src.ino File Reference}
\label{svea__arduino__src_8ino}\index{/home/nvidia/starter\+\_\+ws/src/svea\+\_\+starter/src/svea\+\_\+arduino/svea\+\_\+arduino\+\_\+src/svea\+\_\+arduino\+\_\+src.\+ino@{/home/nvidia/starter\+\_\+ws/src/svea\+\_\+starter/src/svea\+\_\+arduino/svea\+\_\+arduino\+\_\+src/svea\+\_\+arduino\+\_\+src.\+ino}}
{\ttfamily \#include $<$ros.\+h$>$}\\*
{\ttfamily \#include $<$svea\+\_\+arduino/lli\+\_\+ctrl.\+h$>$}\\*
{\ttfamily \#include $<$svea\+\_\+arduino/lli\+\_\+encoder.\+h$>$}\\*
{\ttfamily \#include $<$Wire.\+h$>$}\\*
{\ttfamily \#include $<$Adafruit\+\_\+\+P\+W\+M\+Servo\+Driver.\+h$>$}\\*
{\ttfamily \#include \char`\"{}settings.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}svea\+\_\+arduino\+\_\+src.\+h\char`\"{}}\\*
Include dependency graph for svea\+\_\+arduino\+\_\+src.\+ino\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{svea__arduino__src_8ino__incl}
\end{center}
\end{figure}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{svea__arduino__src_8ino_adab070eb39b45b4c79b5d7e3cafa9514}{set\+\_\+pwm\+\_\+driver} (uint8\+\_\+t channel, int8\+\_\+t in\+\_\+value)
\begin{DoxyCompactList}\small\item\em Set actuation P\+WM convert a 8 bit actuation value to a pwm signal and send it to the pwm board. The value gets scaled to a duration that suits the servos (approximately 1 to 2 milli seconds). The scalling uses frequency measurements from pin 10 on the pwm board. \end{DoxyCompactList}\item 
void \hyperlink{svea__arduino__src_8ino_aa5545eb35f187e5fd11a483a265bed7b}{actuate} (const int8\+\_\+t actuation\+\_\+values\mbox{[}$\,$\mbox{]})
\begin{DoxyCompactList}\small\item\em Send settings to the pwm board through \hyperlink{svea__arduino__src_8ino_adab070eb39b45b4c79b5d7e3cafa9514}{set\+\_\+pwm\+\_\+driver()} \end{DoxyCompactList}\item 
uint8\+\_\+t \hyperlink{svea__arduino__src_8ino_ad7d57085af575cbb5dc21e523f3a3321}{set\+\_\+actuated\+\_\+code} ()\hypertarget{svea__arduino__src_8ino_ad7d57085af575cbb5dc21e523f3a3321}{}\label{svea__arduino__src_8ino_ad7d57085af575cbb5dc21e523f3a3321}

\begin{DoxyCompactList}\small\item\em set the control code in messages sent to the computer \end{DoxyCompactList}\item 
void \hyperlink{svea__arduino__src_8ino_ae79b6def446edd5a233efe74bc1f2a7b}{cb\+\_\+ctrl\+\_\+request} (const \hyperlink{svea__arduino__src_8h_a397644608f772ef60685f6a938f43ea1}{lli\+\_\+ctrl\+\_\+in} \&data)
\begin{DoxyCompactList}\small\item\em Callback function for control requests from R\+OS Interprets the message and sends the values to the pwm board through \hyperlink{svea__arduino__src_8ino_aa5545eb35f187e5fd11a483a265bed7b}{actuate()}. \end{DoxyCompactList}\item 
void \hyperlink{svea__arduino__src_8ino_af99fa97e441e842b197dacc4a1a95a99}{process\+Pwm} ()
\begin{DoxyCompactList}\small\item\em Handle pwm events. \end{DoxyCompactList}\item 
void \hyperlink{svea__arduino__src_8ino_a2948125fe6592c36c5c0e641478e2db0}{pwm\+Event} ()\hypertarget{svea__arduino__src_8ino_a2948125fe6592c36c5c0e641478e2db0}{}\label{svea__arduino__src_8ino_a2948125fe6592c36c5c0e641478e2db0}

\begin{DoxyCompactList}\small\item\em Called when a pwm signal from the remote has been recieved Takes the actuation values from the remote and sends them to R\+OS. The frequency of the R\+OS messages is around 100 Hz, based on the frequency of the reciever. If the computer is not sending any signals or the \hyperlink{group__StatusVariables_gae31e17311163c382d2de940091954419}{R\+E\+M\+\_\+\+O\+V\+E\+R\+R\+I\+DE} flag is set (by pushing the deifferential switch to the formost position) the actuation values will also be sent to the pwm board through \hyperlink{svea__arduino__src_8ino_aa5545eb35f187e5fd11a483a265bed7b}{actuate()}. \end{DoxyCompactList}\item 
int8\+\_\+t \hyperlink{svea__arduino__src_8ino_a1c4a5154127fe3f9963eb968b0714b90}{pwm\+\_\+to\+\_\+actuation} (unsigned long duration)
\item 
void \hyperlink{svea__arduino__src_8ino_ab3d64504be0ebfe1754aec5485ddbb72}{tune\+\_\+pwm\+\_\+freq} ()\hypertarget{svea__arduino__src_8ino_ab3d64504be0ebfe1754aec5485ddbb72}{}\label{svea__arduino__src_8ino_ab3d64504be0ebfe1754aec5485ddbb72}

\begin{DoxyCompactList}\small\item\em Tune the frequency of the pwm board Measure the frequency from the pwm board on pin 10 and adjust the frequency to match \hyperlink{group__ActuationToOutput_ga1e7ca795ca78a0b20f4fbc06ea505cfb}{P\+W\+M\+\_\+\+F\+R\+E\+Q\+U\+E\+N\+CY} Will then measure the adjusted value and futher tune \hyperlink{group__ActuationToOutput_gaa6aecad7bb848a436df0b7c89aa1f48f}{P\+W\+M\+\_\+\+N\+E\+U\+T\+R\+A\+L\+\_\+\+T\+I\+CK} and \hyperlink{group__ActuationToOutput_ga8e7323c31db382601e81947c2bba345b}{I\+N\+P\+U\+T\+\_\+\+S\+C\+A\+LE}. If Pin D3 is not connected to pin 10 on the pwm board weirdnes might ensue. \end{DoxyCompactList}\item 
void \hyperlink{svea__arduino__src_8ino_a11eacef653351913656e56d12c152346}{process\+Encoder\+Ticks} ()
\begin{DoxyCompactList}\small\item\em Count the encoder ticks since last call and send the result to R\+OS. \end{DoxyCompactList}\item 
\hyperlink{svea__arduino__src_8ino_afea150fcd685610cb9f7672fce361e53}{I\+SR} (I\+N\+T0\+\_\+vect)
\begin{DoxyCompactList}\small\item\em Interrupt on D2, for detecting rising edges in the pwm signal from the reciever. \end{DoxyCompactList}\item 
\hyperlink{svea__arduino__src_8ino_a22acfb428840c6d9aa212764589cf6c6}{I\+SR} (I\+N\+T1\+\_\+vect)\hypertarget{svea__arduino__src_8ino_a22acfb428840c6d9aa212764589cf6c6}{}\label{svea__arduino__src_8ino_a22acfb428840c6d9aa212764589cf6c6}

\begin{DoxyCompactList}\small\item\em Interrupt on D3, measures frequency of the pwm board. Used for tuning the pwm frequency. D3 should be connected to pin 10 on the pwm board. \end{DoxyCompactList}\item 
\hyperlink{svea__arduino__src_8ino_aa64c6dce15e9de9105b4ae9533c9a267}{I\+SR} (P\+C\+I\+N\+T0\+\_\+vect)\hypertarget{svea__arduino__src_8ino_aa64c6dce15e9de9105b4ae9533c9a267}{}\label{svea__arduino__src_8ino_aa64c6dce15e9de9105b4ae9533c9a267}

\begin{DoxyCompactList}\small\item\em Detects falling edges from the reciever pwm. Interrupt on pins D8 ... D12 (P\+O\+R\+TB) Called on pin change on any reciever channel Store time and the pins that have changed in buffers on falling edges and ignores rising edges. \end{DoxyCompactList}\item 
\hyperlink{svea__arduino__src_8ino_a9c4665742c6b6eb1f0bb9dde41f7cba3}{I\+SR} (P\+C\+I\+N\+T2\+\_\+vect)\hypertarget{svea__arduino__src_8ino_a9c4665742c6b6eb1f0bb9dde41f7cba3}{}\label{svea__arduino__src_8ino_a9c4665742c6b6eb1f0bb9dde41f7cba3}

\begin{DoxyCompactList}\small\item\em Detect ticks from the wheel encoders. Interrupt on pins D0 ... D7 (P\+O\+R\+TD) Called on ticks from eithr encoder. Detects changes in pin values of pin D6 (right wheel) and D7 (left wheel). And increments the tickcounts R\+I\+G\+H\+T\+\_\+\+T\+I\+C\+K\+\_\+\+C\+O\+U\+NT and L\+E\+F\+T\+\_\+\+T\+I\+C\+K\+\_\+\+C\+O\+U\+NT accordingly. \end{DoxyCompactList}\item 
void \hyperlink{svea__arduino__src_8ino_a4fc01d736fe50cf5b977f755b675f11d}{setup} ()\hypertarget{svea__arduino__src_8ino_a4fc01d736fe50cf5b977f755b675f11d}{}\label{svea__arduino__src_8ino_a4fc01d736fe50cf5b977f755b675f11d}

\begin{DoxyCompactList}\small\item\em Arduino setup function. \end{DoxyCompactList}\item 
void \hyperlink{svea__arduino__src_8ino_afe461d27b9c48d5921c00d521181f12f}{loop} ()\hypertarget{svea__arduino__src_8ino_afe461d27b9c48d5921c00d521181f12f}{}\label{svea__arduino__src_8ino_afe461d27b9c48d5921c00d521181f12f}

\begin{DoxyCompactList}\small\item\em Main loop. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\index{svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}!actuate@{actuate}}
\index{actuate@{actuate}!svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}}
\subsubsection[{\texorpdfstring{actuate(const int8\+\_\+t actuation\+\_\+values[])}{actuate(const int8_t actuation_values[])}}]{\setlength{\rightskip}{0pt plus 5cm}void actuate (
\begin{DoxyParamCaption}
\item[{const int8\+\_\+t}]{actuation\+\_\+values\mbox{[}$\,$\mbox{]}}
\end{DoxyParamCaption}
)}\hypertarget{svea__arduino__src_8ino_aa5545eb35f187e5fd11a483a265bed7b}{}\label{svea__arduino__src_8ino_aa5545eb35f187e5fd11a483a265bed7b}


Send settings to the pwm board through \hyperlink{svea__arduino__src_8ino_adab070eb39b45b4c79b5d7e3cafa9514}{set\+\_\+pwm\+\_\+driver()} 

\begin{DoxySeeAlso}{See also}
\hyperlink{svea__arduino__src_8ino_adab070eb39b45b4c79b5d7e3cafa9514}{set\+\_\+pwm\+\_\+driver} 
\end{DoxySeeAlso}

\begin{DoxyParams}{Parameters}
{\em actuation\+\_\+values} & array containg 5 values. \\
\hline
\end{DoxyParams}


Definition at line 41 of file svea\+\_\+arduino\+\_\+src.\+ino.

\index{svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}!cb\+\_\+ctrl\+\_\+request@{cb\+\_\+ctrl\+\_\+request}}
\index{cb\+\_\+ctrl\+\_\+request@{cb\+\_\+ctrl\+\_\+request}!svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}}
\subsubsection[{\texorpdfstring{cb\+\_\+ctrl\+\_\+request(const lli\+\_\+ctrl\+\_\+in \&data)}{cb_ctrl_request(const lli_ctrl_in &data)}}]{\setlength{\rightskip}{0pt plus 5cm}void cb\+\_\+ctrl\+\_\+request (
\begin{DoxyParamCaption}
\item[{const {\bf lli\+\_\+ctrl\+\_\+in} \&}]{data}
\end{DoxyParamCaption}
)}\hypertarget{svea__arduino__src_8ino_ae79b6def446edd5a233efe74bc1f2a7b}{}\label{svea__arduino__src_8ino_ae79b6def446edd5a233efe74bc1f2a7b}


Callback function for control requests from R\+OS Interprets the message and sends the values to the pwm board through \hyperlink{svea__arduino__src_8ino_aa5545eb35f187e5fd11a483a265bed7b}{actuate()}. 


\begin{DoxyParams}{Parameters}
{\em data} & Message to be evaluated \\
\hline
\end{DoxyParams}


Definition at line 94 of file svea\+\_\+arduino\+\_\+src.\+ino.

\index{svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}!I\+SR@{I\+SR}}
\index{I\+SR@{I\+SR}!svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}}
\subsubsection[{\texorpdfstring{I\+S\+R(\+I\+N\+T0\+\_\+vect)}{ISR(INT0_vect)}}]{\setlength{\rightskip}{0pt plus 5cm}I\+SR (
\begin{DoxyParamCaption}
\item[{I\+N\+T0\+\_\+vect}]{}
\end{DoxyParamCaption}
)}\hypertarget{svea__arduino__src_8ino_afea150fcd685610cb9f7672fce361e53}{}\label{svea__arduino__src_8ino_afea150fcd685610cb9f7672fce361e53}


Interrupt on D2, for detecting rising edges in the pwm signal from the reciever. 

Called on rising edge of steering The rising edges of all pwm signals from the reciever are synced, so only one start time is necessary. 

Definition at line 366 of file svea\+\_\+arduino\+\_\+src.\+ino.

\index{svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}!process\+Encoder\+Ticks@{process\+Encoder\+Ticks}}
\index{process\+Encoder\+Ticks@{process\+Encoder\+Ticks}!svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}}
\subsubsection[{\texorpdfstring{process\+Encoder\+Ticks()}{processEncoderTicks()}}]{\setlength{\rightskip}{0pt plus 5cm}void process\+Encoder\+Ticks (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{svea__arduino__src_8ino_a11eacef653351913656e56d12c152346}{}\label{svea__arduino__src_8ino_a11eacef653351913656e56d12c152346}


Count the encoder ticks since last call and send the result to R\+OS. 

The time\+\_\+delta is given in 10 micro seconds resolution. 

Definition at line 331 of file svea\+\_\+arduino\+\_\+src.\+ino.

\index{svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}!process\+Pwm@{process\+Pwm}}
\index{process\+Pwm@{process\+Pwm}!svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}}
\subsubsection[{\texorpdfstring{process\+Pwm()}{processPwm()}}]{\setlength{\rightskip}{0pt plus 5cm}void process\+Pwm (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{svea__arduino__src_8ino_af99fa97e441e842b197dacc4a1a95a99}{}\label{svea__arduino__src_8ino_af99fa97e441e842b197dacc4a1a95a99}


Handle pwm events. 

Reads all the values from \hyperlink{group__PwmMeasurtement_ga1980b7b5ba1ceabb0b5c60c9da70164e}{P\+W\+M\+\_\+\+T\+\_\+\+B\+U\+F\+F\+ER} and \hyperlink{group__PwmMeasurtement_gaed4f8ecf3e1ca2d8bfa8904a43729f57}{P\+W\+M\+\_\+\+S\+\_\+\+B\+U\+F\+F\+ER} that has been added since the last loop and translates the pwm signal to actuation values. Calls \hyperlink{svea__arduino__src_8ino_a2948125fe6592c36c5c0e641478e2db0}{pwm\+Event()} 3 ms after the last observed rising edge.

Button value directions\+: Ctrl / Value Throttle pulled -\/$>$ Possitve value Steering forward -\/$>$ Possitive value Gear switch up -\/$>$ 0 (Low gear) Gear switch down -\/$>$ 1 (High Gear) Switch back -\/$>$ forward diff 0 (unlocked), back diff 0 (unlocked) Switch middle -\/$>$ forward diff 1 (locked), back diff 0 (unlocked) Switch middle -\/$>$ forward diff 1 (locked), back diff 1 (locked) and R\+E\+M\+\_\+\+O\+V\+E\+R\+R\+I\+DE = true 

Definition at line 140 of file svea\+\_\+arduino\+\_\+src.\+ino.

\index{svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}!pwm\+\_\+to\+\_\+actuation@{pwm\+\_\+to\+\_\+actuation}}
\index{pwm\+\_\+to\+\_\+actuation@{pwm\+\_\+to\+\_\+actuation}!svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}}
\subsubsection[{\texorpdfstring{pwm\+\_\+to\+\_\+actuation(unsigned long duration)}{pwm_to_actuation(unsigned long duration)}}]{\setlength{\rightskip}{0pt plus 5cm}int8\+\_\+t pwm\+\_\+to\+\_\+actuation (
\begin{DoxyParamCaption}
\item[{unsigned long}]{duration}
\end{DoxyParamCaption}
)}\hypertarget{svea__arduino__src_8ino_a1c4a5154127fe3f9963eb968b0714b90}{}\label{svea__arduino__src_8ino_a1c4a5154127fe3f9963eb968b0714b90}
Convert a pwm duration to an actuation value Usese measurements of pin 10 on the pwm board. \begin{DoxySeeAlso}{See also}
\hyperlink{svea__arduino__src_8ino_ab3d64504be0ebfe1754aec5485ddbb72}{tune\+\_\+pwm\+\_\+freq()} 
\end{DoxySeeAlso}

\begin{DoxyParams}{Parameters}
{\em duration} & Duration of the high part of the pwm signal in micro seconds. \\
\hline
\end{DoxyParams}


Definition at line 266 of file svea\+\_\+arduino\+\_\+src.\+ino.

\index{svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}!set\+\_\+pwm\+\_\+driver@{set\+\_\+pwm\+\_\+driver}}
\index{set\+\_\+pwm\+\_\+driver@{set\+\_\+pwm\+\_\+driver}!svea\+\_\+arduino\+\_\+src.\+ino@{svea\+\_\+arduino\+\_\+src.\+ino}}
\subsubsection[{\texorpdfstring{set\+\_\+pwm\+\_\+driver(uint8\+\_\+t channel, int8\+\_\+t in\+\_\+value)}{set_pwm_driver(uint8_t channel, int8_t in_value)}}]{\setlength{\rightskip}{0pt plus 5cm}void set\+\_\+pwm\+\_\+driver (
\begin{DoxyParamCaption}
\item[{uint8\+\_\+t}]{channel, }
\item[{int8\+\_\+t}]{in\+\_\+value}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\hypertarget{svea__arduino__src_8ino_adab070eb39b45b4c79b5d7e3cafa9514}{}\label{svea__arduino__src_8ino_adab070eb39b45b4c79b5d7e3cafa9514}


Set actuation P\+WM convert a 8 bit actuation value to a pwm signal and send it to the pwm board. The value gets scaled to a duration that suits the servos (approximately 1 to 2 milli seconds). The scalling uses frequency measurements from pin 10 on the pwm board. 

\begin{DoxySeeAlso}{See also}
\hyperlink{group__ActuationToOutput_ga8e7323c31db382601e81947c2bba345b}{I\+N\+P\+U\+T\+\_\+\+S\+C\+A\+LE} 

\hyperlink{group__ActuationToOutput_gaa6aecad7bb848a436df0b7c89aa1f48f}{P\+W\+M\+\_\+\+N\+E\+U\+T\+R\+A\+L\+\_\+\+T\+I\+CK} To avoid servo jitter at neutral a small dead zone exists around 0. 

\hyperlink{settings_8h_a8f059a42c098816d4ccebaf48add0a4a}{D\+E\+A\+D\+\_\+\+Z\+O\+NE} 
\end{DoxySeeAlso}

\begin{DoxyParams}{Parameters}
{\em channel} & The channel (pin) of the pwm board to send to. \\
\hline
{\em in\+\_\+value} & Value, between -\/127 and 127. to send. \\
\hline
\end{DoxyParams}


Definition at line 27 of file svea\+\_\+arduino\+\_\+src.\+ino.

